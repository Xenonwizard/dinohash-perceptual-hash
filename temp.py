text = """
failed at 28 with score [{'index': 1837, 'score': 0.587890625}, {'index': 8245, 'score': 0.59375}, {'index': 3032, 'score': 0.6032986111111112}, {'index': 7668, 's
core': 0.625}, {'index': 4888, 'score': 0.6163194444444444}]                     
failed at 63 with score [{'index': 7576, 'score': 0.5758928571428571}, {'index': 1837, 'score': 0.5817708333333333}, {'index': 8870, 'score': 0.5770833333333333}, 
{'index': 6598, 'score': 0.5762648809523809}, {'index': 9058, 'score': 0.5789930555555556}]                                                                        
failed at 82 with score [{'index': 7018, 'score': 0.5740327380952381}, {'index': 4353, 'score': 0.5747767857142857}, {'index': 9198, 'score': 0.5749007936507936}, 
{'index': 1007, 'score': 0.5831207482993197}, {'index': 1816, 'score': 0.5798611111111112}]                                                                        
failed at 86 with score [{'index': 8252, 'score': 0.5442708333333334}, {'index': 6997, 'score': 0.5484375}, {'index': 9855, 'score': 0.5494791666666666}, {'index':
 5565, 'score': 0.5520833333333334}, {'index': 8381, 'score': 0.5540123456790124}]                                                                                 
failed at 154 with score [{'index': 6887, 'score': 0.5752314814814815}, {'index': 2232, 'score': 0.5833333333333334}, {'index': 44, 'score': 0.5972222222222222}, {
'index': 1382, 'score': 0.5828125}, {'index': 4318, 'score': 0.5810185185185185}]
failed at 157 with score [{'index': 4888, 'score': 0.5434027777777778}, {'index': 4065, 'score': 0.5441666666666667}, {'index': 6658, 'score': 0.5512152777777778},
 {'index': 9803, 'score': 0.5677083333333334}, {'index': 9152, 'score': 0.57421875}]                                                                               
failed at 184 with score [{'index': 5804, 'score': 0.5598958333333334}, {'index': 9225, 'score': 0.5611979166666666}, {'index': 3110, 'score': 0.565625}, {'index':
 2722, 'score': 0.5660807291666666}, {'index': 5290, 'score': 0.5708333333333333}]                                                                                 
failed at 265 with score [{'index': 9058, 'score': 0.5659722222222222}, {'index': 9594, 'score': 0.5703125}, {'index': 2938, 'score': 0.5703125}, {'index': 4954, '
score': 0.5791666666666667}, {'index': 2573, 'score': 0.5791666666666667}]       
failed at 327 with score [{'index': 1060, 'score': 0.5603298611111112}, {'index': 9152, 'score': 0.5620039682539683}, {'index': 9217, 'score': 0.578125}, {'index':
 3166, 'score': 0.5697916666666667}, {'index': 994, 'score': 0.5661892361111112}]
failed at 665 with score [{'index': 4854, 'score': 0.5896464646464646}, {'index': 1279, 'score': 0.5910493827160493}, {'index': 7940, 'score': 0.5950126262626263},
 {'index': 3818, 'score': 0.5930555555555556}, {'index': 7868, 'score': 0.6014660493827161}]                                                                       
failed at 680 with score [{'index': 7465, 'score': 0.5427083333333333}, {'index': 6397, 'score': 0.5451388888888888}, {'index': 3203, 'score': 0.546875}, {'index':
 9855, 'score': 0.5572916666666666}, {'index': 2393, 'score': 0.55}]             
failed at 788 with score [{'index': 7645, 'score': 0.5795833333333333}, {'index': 6687, 'score': 0.5833333333333334}, {'index': 9223, 'score': 0.5836309523809524},
 {'index': 8026, 'score': 0.5892361111111111}, {'index': 6355, 'score': 0.5861111111111111}]                                                                       
failed at 877 with score [{'index': 5523, 'score': 0.5770833333333333}, {'index': 2973, 'score': 0.5789930555555556}, {'index': 7758, 'score': 0.5798611111111112},
 {'index': 2466, 'score': 0.5826388888888889}, {'index': 5316, 'score': 0.5840277777777778}]                                                                       
failed at 1066 with score [{'index': 4540, 'score': 0.5784722222222223}, {'index': 468, 'score': 0.5792824074074074}, {'index': 3003, 'score': 0.5833333333333334},
 {'index': 9313, 'score': 0.5859375}, {'index': 5284, 'score': 0.5833333333333334}]                                                                                
failed at 1157 with score [{'index': 7159, 'score': 0.5498511904761905}, {'index': 6211, 'score': 0.5509259259259259}, {'index': 981, 'score': 0.5546875}, {'index'
: 2820, 'score': 0.5555555555555556}, {'index': 4430, 'score': 0.5633680555555556}]                                                                                
failed at 1201 with score [{'index': 1088, 'score': 0.6076388888888888}, {'index': 8306, 'score': 0.6104166666666667}, {'index': 7247, 'score': 0.6114583333333333}
, {'index': 9136, 'score': 0.6127976190476191}, {'index': 9058, 'score': 0.6354166666666666}]                                                                      
failed at 1371 with score [{'index': 8203, 'score': 0.5763888888888888}, {'index': 8693, 'score': 0.5768229166666666}, {'index': 2745, 'score': 0.5810185185185185}
, {'index': 4318, 'score': 0.5815972222222222}, {'index': 4954, 'score': 0.5802083333333333}]                                                                      
failed at 1396 with score [{'index': 3822, 'score': 0.6}, {'index': 1150, 'score': 0.6059027777777778}, {'index': 7800, 'score': 0.6232638888888888}, {'index': 135
3, 'score': 0.6154513888888888}, {'index': 5109, 'score': 0.6087962962962963}]   
failed at 1418 with score [{'index': 2393, 'score': 0.565625}, {'index': 5823, 'score': 0.5659722222222222}, {'index': 6640, 'score': 0.5677083333333334}, {'index'
: 2536, 'score': 0.5708912037037037}, {'index': 9101, 'score': 0.5750868055555556}]                                                                                
failed at 1461 with score [{'index': 2268, 'score': 0.5708333333333333}, {'index': 9318, 'score': 0.5729166666666666}, {'index': 4826, 'score': 0.5760416666666667}
, {'index': 5867, 'score': 0.5807291666666666}, {'index': 6867, 'score': 0.5844907407407407}]                                                                      
failed at 1484 with score [{'index': 8261, 'score': 0.5667317708333334}, {'index': 8203, 'score': 0.5677083333333334}, {'index': 7625, 'score': 0.5703125}, {'index
': 1309, 'score': 0.5710565476190477}, {'index': 3152, 'score': 0.5748697916666666}]                                                                               
failed at 1506 with score [{'index': 5492, 'score': 0.5428240740740741}, {'index': 9860, 'score': 0.5436197916666666}, {'index': 6777, 'score': 0.5454282407407407}
, {'index': 9278, 'score': 0.546875}, {'index': 8203, 'score': 0.5590277777777778}]                                                                                
failed at 1527 with score [{'index': 6291, 'score': 0.5636574074074074}, {'index': 4917, 'score': 0.5716145833333334}, {'index': 5225, 'score': 0.5677083333333334}
, {'index': 4888, 'score': 0.5651041666666666}, {'index': 4598, 'score': 0.5854166666666667}]                                                                      
failed at 1562 with score [{'index': 3009, 'score': 0.5983072916666666}, {'index': 9593, 'score': 0.5998263888888888}, {'index': 1392, 'score': 0.6180555555555556}
, {'index': 7668, 'score': 0.63671875}, {'index': 8245, 'score': 0.6041666666666666}]                                                                              
failed at 1582 with score [{'index': 2771, 'score': 0.5677083333333334}, {'index': 150, 'score': 0.5685763888888888}, {'index': 9225, 'score': 0.5716145833333334},
 {'index': 44, 'score': 0.59375}, {'index': 218, 'score': 0.5695684523809523}]   
failed at 1693 with score [{'index': 6847, 'score': 0.5881076388888888}, {'index': 6012, 'score': 0.5885416666666666}, {'index': 316, 'score': 0.607421875}, {'inde
x': 5995, 'score': 0.5966435185185185}, {'index': 375, 'score': 0.5947916666666667}]                                                                               
failed at 1764 with score [{'index': 9749, 'score': 0.5638020833333334}, {'index': 1742, 'score': 0.5682043650793651}, {'index': 6766, 'score': 0.5697337962962963}
, {'index': 5389, 'score': 0.5826388888888889}, {'index': 6293, 'score': 0.5833333333333334}]                                                                      
failed at 1865 with score [{'index': 760, 'score': 0.5475}, {'index': 6160, 'score': 0.5555555555555556}, {'index': 883, 'score': 0.5493055555555556}, {'index': 28
4, 'score': 0.5555555555555556}, {'index': 6716, 'score': 0.5526041666666667}]   
failed at 1898 with score [{'index': 3206, 'score': 0.5752314814814815}, {'index': 494, 'score': 0.578125}, {'index': 6754, 'score': 0.5859375}, {'index': 8236, 's
core': 0.5983333333333334}, {'index': 5340, 'score': 0.5911458333333334}]        
failed at 2012 with score [{'index': 967, 'score': 0.5821759259259259}, {'index': 7300, 'score': 0.5838293650793651}, {'index': 4586, 'score': 0.594812925170068}, 
{'index': 7928, 'score': 0.6076388888888888}, {'index': 6394, 'score': 0.5868055555555556}]                                                                        
failed at 2014 with score [{'index': 442, 'score': 0.5526041666666667}, {'index': 1600, 'score': 0.5551215277777778}, {'index': 4637, 'score': 0.5586309523809524},
 {'index': 5867, 'score': 0.5631510416666666}, {'index': 216, 'score': 0.559375}]
failed at 2070 with score [{'index': 734, 'score': 0.5773809523809523}, {'index': 8920, 'score': 0.5800595238095239}, {'index': 3606, 'score': 0.5821428571428572},
 {'index': 5749, 'score': 0.5883928571428572}, {'index': 2934, 'score': 0.5863095238095238}]                                                                       
failed at 2163 with score [{'index': 7237, 'score': 0.5479600694444444}, {'index': 5771, 'score': 0.5646701388888888}, {'index': 7643, 'score': 0.5568576388888888}
, {'index': 5695, 'score': 0.5496031746031746}, {'index': 7754, 'score': 0.5569444444444445}]                                                                      
failed at 2339 with score [{'index': 3747, 'score': 0.5807291666666666}, {'index': 2426, 'score': 0.5885416666666666}, {'index': 2048, 'score': 0.5901041666666667}
, {'index': 4930, 'score': 0.5928819444444444}, {'index': 6160, 'score': 0.6041666666666666}]                                                                      
failed at 2410 with score [{'index': 2692, 'score': 0.6020833333333333}, {'index': 9174, 'score': 0.6059027777777778}, {'index': 5804, 'score': 0.60625}, {'index':
 9226, 'score': 0.6135416666666667}, {'index': 8358, 'score': 0.609375}]                                                                                           
failed at 2416 with score [{'index': 2636, 'score': 0.5786458333333333}, {'index': 8870, 'score': 0.5792824074074074}, {'index': 5995, 'score': 0.5895833333333333}
, {'index': 586, 'score': 0.5881696428571429}, {'index': 8203, 'score': 0.59375}]                                                                                  
failed at 2419 with score [{'index': 9603, 'score': 0.546875}, {'index': 6283, 'score': 0.5473958333333333}, {'index': 618, 'score': 0.552734375}, {'index': 5098, 
'score': 0.5559895833333334}, {'index': 908, 'score': 0.5609375}]                                                                                                  
failed at 2456 with score [{'index': 8637, 'score': 0.5510416666666667}, {'index': 9855, 'score': 0.5572916666666666}, {'index': 4388, 'score': 0.5554166666666667}
, {'index': 8009, 'score': 0.5546875}, {'index': 9313, 'score': 0.5604166666666667}]                                                                               
failed at 2467 with score [{'index': 8644, 'score': 0.5755208333333334}, {'index': 592, 'score': 0.5760416666666667}, {'index': 4765, 'score': 0.5791666666666667},
 {'index': 4917, 'score': 0.5859375}, {'index': 6878, 'score': 0.596875}]                                                                                          
failed at 2581 with score [{'index': 2475, 'score': 0.5868055555555556}, {'index': 4962, 'score': 0.5868055555555556}, {'index': 218, 'score': 0.5928819444444444},
 {'index': 4572, 'score': 0.5933159722222222}, {'index': 150, 'score': 0.5963541666666666}]                                                                        
failed at 2688 with score [{'index': 4190, 'score': 0.54375}, {'index': 9278, 'score': 0.5442708333333334}, {'index': 6397, 'score': 0.5451388888888888}, {'index':
 7466, 'score': 0.5595238095238095}, {'index': 9312, 'score': 0.5504918981481481}]                                                                                 
failed at 2701 with score [{'index': 9278, 'score': 0.5807291666666666}, {'index': 7514, 'score': 0.5807291666666666}, {'index': 4227, 'score': 0.5826822916666666}
, {'index': 8203, 'score': 0.5850694444444444}, {'index': 6640, 'score': 0.5865885416666666}]                                                                      
failed at 2976 with score [{'index': 7463, 'score': 0.5715277777777777}, {'index': 4760, 'score': 0.5775}, {'index': 2280, 'score': 0.5776041666666667}, {'index': 
5556, 'score': 0.5783333333333334}, {'index': 5995, 'score': 0.5850694444444444}]
failed at 3047 with score [{'index': 3076, 'score': 0.5481770833333334}, {'index': 9923, 'score': 0.548828125}, {'index': 4318, 'score': 0.5494791666666666}, {'ind
ex': 4954, 'score': 0.55}, {'index': 4413, 'score': 0.55078125}]                 
failed at 3178 with score [{'index': 9170, 'score': 0.5798611111111112}, {'index': 167, 'score': 0.5822916666666667}, {'index': 9225, 'score': 0.5859375}, {'index'
: 5874, 'score': 0.5885416666666666}, {'index': 4276, 'score': 0.5864583333333333}]                                                                                
failed at 3283 with score [{'index': 7156, 'score': 0.5633680555555556}, {'index': 9521, 'score': 0.5642361111111112}, {'index': 8203, 'score': 0.5651041666666666}
, {'index': 4654, 'score': 0.5659722222222222}, {'index': 702, 'score': 0.5720486111111112}] 
failed at 3290 with score [{'index': 9196, 'score': 0.5992772108843537}, {'index': 8904, 'score': 0.6010416666666667}, {'index': 1829, 'score': 0.6039186507936508}
, {'index': 2680, 'score': 0.6061197916666666}, {'index': 8195, 'score': 0.6061507936507936}]                                                                      
failed at 3328 with score [{'index': 4954, 'score': 0.5520833333333334}, {'index': 618, 'score': 0.556640625}, {'index': 1230, 'score': 0.5600694444444444}, {'inde
x': 9174, 'score': 0.5625}, {'index': 4687, 'score': 0.5763888888888888}]        
failed at 3427 with score [{'index': 2734, 'score': 0.5479166666666667}, {'index': 1106, 'score': 0.5486111111111112}, {'index': 7867, 'score': 0.5493055555555556}
, {'index': 6211, 'score': 0.5659722222222222}, {'index': 5567, 'score': 0.5525173611111112}]                                                                      
failed at 3585 with score [{'index': 8447, 'score': 0.5885416666666666}, {'index': 3136, 'score': 0.5911458333333334}, {'index': 8870, 'score': 0.59375}, {'index':
 4954, 'score': 0.6158854166666666}, {'index': 5743, 'score': 0.6119791666666666}]                                                                                 
failed at 3646 with score [{'index': 5567, 'score': 0.5633680555555556}, {'index': 5433, 'score': 0.5655381944444444}, {'index': 2757, 'score': 0.5691666666666667}
, {'index': 9217, 'score': 0.5711805555555556}, {'index': 5383, 'score': 0.5711309523809524}]                                                                      
failed at 3663 with score [{'index': 2350, 'score': 0.5457175925925926}, {'index': 627, 'score': 0.5465277777777777}, {'index': 1986, 'score': 0.548046875}, {'inde
x': 6404, 'score': 0.5486900252525253}, {'index': 8111, 'score': 0.5499131944444444}]                                                                              
failed at 3699 with score [{'index': 8038, 'score': 0.546875}, {'index': 913, 'score': 0.5486111111111112}, {'index': 1855, 'score': 0.5534722222222223}, {'index':
 6997, 'score': 0.5611111111111111}, {'index': 6211, 'score': 0.5543981481481481}]                                                                                 
failed at 3806 with score [{'index': 7234, 'score': 0.5642361111111112}, {'index': 5082, 'score': 0.5707465277777778}, {'index': 4247, 'score': 0.5725694444444445}
, {'index': 4562, 'score': 0.5729166666666666}, {'index': 5641, 'score': 0.6125}]
failed at 3937 with score [{'index': 3870, 'score': 0.5447916666666667}, {'index': 838, 'score': 0.5506944444444445}, {'index': 4477, 'score': 0.5497685185185185},
 {'index': 832, 'score': 0.556640625}, {'index': 3003, 'score': 0.5473958333333333}]                                                                               
failed at 3980 with score [{'index': 8059, 'score': 0.5580357142857143}, {'index': 541, 'score': 0.5729166666666666}, {'index': 8445, 'score': 0.5669642857142857},
 {'index': 6471, 'score': 0.5595833333333333}, {'index': 1162, 'score': 0.5711805555555556}]                                                                       
failed at 4083 with score [{'index': 1230, 'score': 0.57625}, {'index': 8765, 'score': 0.5789930555555556}, {'index': 2339, 'score': 0.5796875}, {'index': 1114, 's
core': 0.58}, {'index': 8525, 'score': 0.5802951388888888}]                      
failed at 4156 with score [{'index': 1617, 'score': 0.5657552083333334}, {'index': 1088, 'score': 0.5711805555555556}, {'index': 11, 'score': 0.5734126984126984}, 
{'index': 8693, 'score': 0.5807291666666666}, {'index': 2634, 'score': 0.578125}]
failed at 4246 with score [{'index': 7851, 'score': 0.540625}, {'index': 2061, 'score': 0.5416666666666666}, {'index': 1814, 'score': 0.5434027777777778}, {'index'
: 9894, 'score': 0.5427083333333333}, {'index': 1764, 'score': 0.5439814814814815}]                                                                                
failed at 4338 with score [{'index': 2288, 'score': 0.5607638888888888}, {'index': 8083, 'score': 0.5625}, {'index': 9855, 'score': 0.5677083333333334}, {'index': 
6390, 'score': 0.5645833333333333}, {'index': 6658, 'score': 0.5616319444444444}]
failed at 4483 with score [{'index': 9259, 'score': 0.5638888888888889}, {'index': 4883, 'score': 0.5647786458333334}, {'index': 5769, 'score': 0.5657242063492064}
, {'index': 9923, 'score': 0.572265625}, {'index': 2938, 'score': 0.5703125}]                         
"""

import os
import shutil
import copy
from PIL import Image
from utils import match, create_model, transform, reparametricize, chunk_call, tilize_by_anchors
import torch

MIN_MARGIN = 0.4

dataset_folder = './dataset/imagenet/images'
image_files = [f for f in os.listdir(dataset_folder)][:10_000]
indices = []
model = create_model("finetuned_mobilenetv3.pth")

for line in text.split("\n"):
    if "failed" in line:
        indices.append(int(line.split(" ")[2]))

images = [copy.deepcopy(Image.open(os.path.join(dataset_folder, image_file)).convert("RGB")) for image_file in image_files]
image_arrays = [transform(image) for image in images]

anchor_points_list = chunk_call(model, torch.stack(image_arrays), 256)
anchor_points_list = reparametricize(anchor_points_list, MIN_MARGIN).numpy()
for anchor_points, index in zip(anchor_points_list, indices):
    print(anchor_points, image_files[index])

# os.makedirs("failed_images", exist_ok=True)
# for index in indices:
#     shutil.copy(f"{dataset_folder}/{image_files[index]}", f"failed_images/{image_files[index]}")